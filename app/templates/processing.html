{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-8 mx-auto text-center">
        <h2 class="mb-4"><i class="fas fa-cogs"></i> Processing Your Data</h2>
        
        <div class="card">
            <div class="card-body">
                <div class="progress mb-3" style="height: 30px;">
                    <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" 
                         role="progressbar" style="width: 0%">0%</div>
                </div>
                
                <p id="status-message" class="lead">Initializing processing...</p>
                
                <div id="success-message" class="alert alert-success d-none">
                    <h4><i class="fas fa-check-circle"></i> Processing Complete!</h4>
                    <p>Your data has been successfully processed.</p>
                    <a id="results-link" href="#" class="btn btn-success">
                        <i class="fas fa-chart-bar"></i> View Results
                    </a>
                </div>
                
                <div id="error-message" class="alert alert-danger d-none">
                    <h4><i class="fas fa-exclamation-circle"></i> Processing Failed</h4>
                    <p id="error-details"></p>
                    <a href="{{ url_for('upload_files') }}" class="btn btn-primary">
                        <i class="fas fa-redo"></i> Try Again
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const jobId = "{{ job_id }}";
    
    function checkStatus() {
        fetch(`/status/${jobId}`)
            .then(response => response.json())
            .then(data => {
                // Update progress bar
                const progressBar = document.getElementById('progress-bar');
                progressBar.style.width = `${data.progress}%`;
                progressBar.textContent = `${data.progress}%`;
                
                // Update status message
                document.getElementById('status-message').textContent = data.message || `Processing: ${data.progress}% complete`;
                
                if (data.status === 'completed') {
                    // Show success message
                    document.getElementById('success-message').classList.remove('d-none');
                    document.getElementById('results-link').href = `/results/${jobId}`;
                    
                    // Stop polling
                    clearInterval(intervalId);
                } else if (data.status === 'failed') {
                    // Show error message
                    document.getElementById('error-message').classList.remove('d-none');
                    document.getElementById('error-details').textContent = data.error || 'An unknown error occurred';
                    
                    // Stop polling
                    clearInterval(intervalId);
                }
            })
            .catch(error => {
                console.error('Error checking status:', error);
            });
    }
    
    // Check status every 2 seconds
    const intervalId = setInterval(checkStatus, 2000);
    checkStatus(); // Initial check
</script>
{% endblock %}
